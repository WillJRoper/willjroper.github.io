<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Euclid FOS Viewer</title>

    <!-- OpenSeadragon from CDN -->
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/openseadragon/4.0.0/openseadragon.min.js"
      integrity="sha512-…"
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    ></script>

    <style>
      html,
      body {
        height: 100%;
        margin: 0;
      }

      #viewer {
        width: 100%;
        height: 100%;
        background: black;
      }

      #controls {
        position: absolute;
        top: 1rem;
        right: 1rem;
        z-index: 10;
      }

      #controls button {
        padding: 0.5em 1em;
        font-size: 1rem;
      }
    </style>
  </head>

  <body>
    <div id="viewer"></div>
    <div id="controls">
      <button id="saveHome">Set Home View</button>
    </div>

    <script>
      const STORAGE_KEY = "euclid_home_view";

      // 1. Initialize viewer
      const viewer = OpenSeadragon({
        element: "viewer",
        prefixUrl:
          "https://cdnjs.cloudflare.com/ajax/libs/openseadragon/4.0.0/images/",
        tileSources: "euclid.dzi",
        showNavigator: true,
      });

      // 2. On open, apply saved viewport if present
      viewer.addHandler("open", () => {
        const saved = JSON.parse(localStorage.getItem(STORAGE_KEY) || "null");
        if (saved && saved.x !== undefined) {
          const rect = new OpenSeadragon.Rect(
            saved.x,
            saved.y,
            saved.width,
            saved.height,
          );
          viewer.viewport.fitBounds(rect, true);
          startIdleReset();
        }
      });

      // 3. “Set Home View” button: grab current bounds → save
      document.getElementById("saveHome").addEventListener("click", () => {
        const bounds = viewer.viewport.getBounds(); // in image coordinates
        const toSave = {
          x: bounds.x,
          y: bounds.y,
          width: bounds.width,
          height: bounds.height,
        };
        localStorage.setItem(STORAGE_KEY, JSON.stringify(toSave));
        alert("Home view saved!");
        startIdleReset();
      });

      // 4. Idle detector: after 30 s no interaction, snap back to home
      function startIdleReset() {
        const LIMIT = 30_000; // ms
        let timer;
        const reset = () => {
          clearTimeout(timer);
          timer = setTimeout(() => {
            const saved = JSON.parse(
              localStorage.getItem(STORAGE_KEY) || "null",
            );
            if (saved) {
              const rect = new OpenSeadragon.Rect(
                saved.x,
                saved.y,
                saved.width,
                saved.height,
              );
              viewer.viewport.fitBounds(rect, true);
            }
          }, LIMIT);
        };
        // interaction events
        [
          "viewport-change",
          "canvas-drag",
          "canvas-click",
          "canvas-scroll",
        ].forEach((evt) => viewer.addHandler(evt, reset));
        reset();
      }
    </script>
  </body>
</html>
