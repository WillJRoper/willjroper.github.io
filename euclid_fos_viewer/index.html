<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Euclid FOS Viewer</title>

    <!-- OpenSeadragon from CDN -->
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/openseadragon/4.0.0/openseadragon.min.js"
      integrity="sha512-…"
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    ></script>

    <style>
      html,
      body {
        height: 100%;
        margin: 0;
      }

      #viewer {
        width: 100%;
        height: 100%;
        background: black;
      }

      #controls {
        position: absolute;
        bottom: 1rem;
        right: 1rem;
        z-index: 10;
      }

      #controls button {
        padding: 0.5em 1em;
        font-size: 1rem;
      }

      #controls button.hidden {
        display: none;
      }
    </style>
  </head>

  <body>
    <div id="viewer"></div>
    <div id="controls">
      <button id="saveHome">Set Home View</button>
    </div>

    <div
      id="debug"
      style="
        position: absolute;
        bottom: 1rem;
        left: 1rem;
        padding: 0.5em;
        background: rgba(0, 0, 0, 0.6);
        color: white;
        font-family: monospace;
        z-index: 100;
      "
    >
      debug info
    </div>

    <script>
      const STORAGE_KEY = "euclid_home_view";

      const viewer = OpenSeadragon({
        element: "viewer",
        prefixUrl:
          "https://cdnjs.cloudflare.com/ajax/libs/openseadragon/4.0.0/images/",
        tileSources: "euclid.dzi",
        showNavigator: true,

        // ← Add these overrides:
        maxZoomPixelRatio: 10, // allow zooming in up to 10x
        minZoomImageRatio: 0.7, // allow zooming out to 70% of image size
        defaultZoomLevel: 1, // start fully zoomed out (1:1 to fit width)

        // make sure your mouse/touch gestures still zoom:
        gestureSettingsMouse: {
          scrollToZoom: true,
          clickToZoom: false,
          dblClickToZoom: true,
          pinchToZoom: true,
        },
      });

      // Hides the save button
      function hideSaveButton() {
        document.getElementById("saveHome").classList.add("hidden");
      }

      // 2. On open, apply saved viewport if present
      viewer.addHandler("open", () => {
        const saved = JSON.parse(localStorage.getItem(STORAGE_KEY) || "null");
        if (saved && saved.x !== undefined) {
          const rect = new OpenSeadragon.Rect(
            saved.x,
            saved.y,
            saved.width,
            saved.height,
          );
          viewer.viewport.fitBounds(rect, true);
          startIdleReset();
          hideSaveButton();
        }
      });

      // 3. “Set Home View” button: grab current bounds → save
      document.getElementById("saveHome").addEventListener("click", () => {
        const bounds = viewer.viewport.getBounds(); // in image coordinates
        const toSave = {
          x: bounds.x,
          y: bounds.y,
          width: bounds.width,
          height: bounds.height,
        };
        localStorage.setItem(STORAGE_KEY, JSON.stringify(toSave));
        alert("Home view saved!");
        startIdleReset();
        hideSaveButton();
      });

      // 4. Idle detector: after 30 s no interaction, snap back to home
      function startIdleReset() {
        const LIMIT = 30_000; // ms
        let timer;
        const reset = () => {
          clearTimeout(timer);
          timer = setTimeout(() => {
            const saved = JSON.parse(
              localStorage.getItem(STORAGE_KEY) || "null",
            );
            if (saved) {
              const rect = new OpenSeadragon.Rect(
                saved.x,
                saved.y,
                saved.width,
                saved.height,
              );
              viewer.viewport.fitBounds(rect, true);
            }
          }, LIMIT);
        };
        // interaction events
        [
          "viewport-change",
          "canvas-drag",
          "canvas-click",
          "canvas-scroll",
        ].forEach((evt) => viewer.addHandler(evt, reset));
        reset();
      }

      // grab the debug panel
      const debug = document.getElementById("debug");

      // helper to update the panel
      function updateDebugInfo() {
        const item = viewer.world.getItemAt(0);
        const bounds = viewer.viewport.getBounds(); // in viewport coords
        const imgRect = item.viewportToImageRectangle(bounds); // in image pixels
        const zoom = viewer.viewport.getZoom(true).toFixed(2); // true = image‐pixels per viewport unit
        debug.textContent = [
          `zoom: ${zoom} px/unit`,
          `view size: ${Math.round(imgRect.width)}×${Math.round(
            imgRect.height,
          )} px`,
          `view origin: ${Math.round(imgRect.x)},${Math.round(imgRect.y)}`,
        ].join("  |  ");
      }

      // wire it up on all pan/zoom events
      ["viewport-change", "canvas-scroll", "canvas-drag", "zoom"].forEach(
        (evt) => {
          viewer.addHandler(evt, updateDebugInfo);
        },
      );

      // also call once on open
      viewer.addHandler("open", updateDebugInfo);
    </script>
  </body>
</html>
